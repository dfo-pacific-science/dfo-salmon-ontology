name: Generate Term Tables

on:
  push:
    branches:
      - main
    paths:
      - 'ontology/**'
      - 'scripts/**'
      - '.github/workflows/generate-term-tables.yml'
  workflow_dispatch:

jobs:
  build:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r scripts/requirements.txt

      - name: Generate term tables
        run: python scripts/extract-term-tables.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: term-tables-${{ github.sha }}
          path: |
            release/artifacts/term-tables/*.csv
            release/artifacts/term-tables/*.meta.json
          if-no-files-found: error

      - name: Dispatch Quarto rebuild
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_DISPATCH_TOKEN != '' && secrets.REPO_DISPATCH_TOKEN || github.token }}
          script: |
            const eventType = 'ontology-term-tables-updated';
            const payload = {
              artifact_name: `term-tables-${process.env.GITHUB_SHA}`,
              commit: process.env.GITHUB_SHA,
            };
            await github.rest.repos.createDispatchEvent({
              owner: 'dfo-pacific-science',
              repo: 'data-stewardship-unit',
              event_type: eventType,
              client_payload: payload,
            });
