name: Validate Ontology

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      ROBOT_VERSION: "1.9.8"
      ROBOT_JAR: tools/robot.jar
      ROBOT_URL: https://github.com/ontodev/robot/releases/download/v1.9.8/robot.jar
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"

      - name: Cache ROBOT jar
        id: cache-robot
        uses: actions/cache@v4
        with:
          path: ${{ env.ROBOT_JAR }}
          key: robot-${{ env.ROBOT_VERSION }}

      - name: Download ROBOT
        if: steps.cache-robot.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$(dirname "$ROBOT_JAR")"
          curl -L "$ROBOT_URL" -o "$ROBOT_JAR"

      - name: ROBOT ELK reasoning (consistency)
        run: make reason

      - name: ROBOT report (profile; fails on ERROR)
        run: ./scripts/robot-quality-check.sh

      - name: Upload ROBOT report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-quality-report
          path: |
            release/artifacts/robot-quality-report.html
            release/artifacts/robot-quality-check.log

  publish-ready:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      ROBOT_VERSION: "1.9.8"
      ROBOT_JAR: tools/robot.jar
      ROBOT_URL: https://github.com/ontodev/robot/releases/download/v1.9.8/robot.jar
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"

      - name: Cache ROBOT jar
        id: cache-robot
        uses: actions/cache@v4
        with:
          path: ${{ env.ROBOT_JAR }}
          key: robot-${{ env.ROBOT_VERSION }}

      - name: Download ROBOT
        if: steps.cache-robot.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$(dirname "$ROBOT_JAR")"
          curl -L "$ROBOT_URL" -o "$ROBOT_JAR"

      - name: SPARQL publish-ready validation (main only)
        run: make publish-validate

      - name: Upload publish-ready outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-ready-validation
          path: |
            release/published/publish-ready-metadata.tsv
