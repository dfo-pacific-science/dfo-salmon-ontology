PREFIX gcdfo: <https://w3id.org/gcdfo/salmon#>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

# Reports ontology terms that are missing gcdfo:theme, exceed the 3-theme cap,
# or reference a theme outside gcdfo:ThemeScheme.
# Note: We intentionally exclude the theme scheme itself and its member theme
# concepts from the "missing theme" check to avoid requiring themes to be themed.
SELECT ?term ?issue ?themeCount
WHERE {
  {
    SELECT ?term (0 AS ?themeCount) ("missing theme" AS ?issue)
    WHERE {
      ?term a ?type .
      FILTER(?type IN (owl:Class, owl:ObjectProperty, owl:DatatypeProperty, owl:AnnotationProperty, skos:Concept, skos:ConceptScheme)) .
      FILTER(!isBlank(?term)) .
      FILTER(STRSTARTS(STR(?term), "https://w3id.org/gcdfo/salmon#")) .
      FILTER(?term != gcdfo:ThemeScheme) .
      FILTER NOT EXISTS { ?term skos:inScheme gcdfo:ThemeScheme } .
      FILTER NOT EXISTS { ?term gcdfo:theme ?theme }
    }
  }
  UNION
  {
    SELECT ?term ?themeCount ("more than 3 themes" AS ?issue)
    WHERE {
      {
        SELECT ?term (COUNT(DISTINCT ?theme) AS ?themeCount)
        WHERE {
          ?term a ?type .
          FILTER(?type IN (owl:Class, owl:ObjectProperty, owl:DatatypeProperty, owl:AnnotationProperty, skos:Concept, skos:ConceptScheme)) .
          FILTER(!isBlank(?term)) .
          FILTER(STRSTARTS(STR(?term), "https://w3id.org/gcdfo/salmon#")) .
          ?term gcdfo:theme ?theme .
        }
        GROUP BY ?term
      }
      FILTER(?themeCount > 3)
    }
  }
  UNION
  {
    SELECT ?term ?themeCount ("theme not in ThemeScheme" AS ?issue)
    WHERE {
      {
        SELECT ?term (COUNT(DISTINCT ?theme) AS ?themeCount)
        WHERE {
          ?term a ?type .
          FILTER(?type IN (owl:Class, owl:ObjectProperty, owl:DatatypeProperty, owl:AnnotationProperty, skos:Concept, skos:ConceptScheme)) .
          FILTER(!isBlank(?term)) .
          FILTER(STRSTARTS(STR(?term), "https://w3id.org/gcdfo/salmon#")) .
          ?term gcdfo:theme ?theme .
          FILTER NOT EXISTS { ?theme skos:inScheme gcdfo:ThemeScheme }
        }
        GROUP BY ?term
      }
      FILTER(?themeCount > 0)
    }
  }
}
ORDER BY ?issue ?term
