PREFIX gcdfo: <https://w3id.org/gcdfo/salmon#>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

# Alpha 0.0.6 migration check:
# Variable concepts must carry the minimum I-ADOPT decomposition metadata:
# - gcdfo:iadoptEntity
# - gcdfo:iadoptProperty
#
# Scope: concepts in explicitly named variable schemes, or schemes whose IRI/label
# indicates "variable" usage.
#
# The query is intentionally dormant until both gcdfo:iadoptEntity and
# gcdfo:iadoptProperty are declared in the ontology.
SELECT DISTINCT ?variable ?scheme ?issue
WHERE {
  FILTER EXISTS { gcdfo:iadoptEntity a owl:AnnotationProperty . }
  FILTER EXISTS { gcdfo:iadoptProperty a owl:AnnotationProperty . }

  ?variable a skos:Concept ;
    skos:inScheme ?scheme .
  ?scheme a skos:ConceptScheme .

  FILTER(
    ?scheme IN (
      gcdfo:VariableScheme,
      gcdfo:ObservedVariableScheme,
      gcdfo:MetricVariableScheme,
      gcdfo:WSPVariableScheme,
      gcdfo:WSPMetricVariableScheme
    )
    || CONTAINS(LCASE(STR(?scheme)), "variablescheme")
    || EXISTS {
      ?scheme skos:prefLabel ?schemeLabel .
      FILTER(LANG(?schemeLabel) = "" || LANGMATCHES(LANG(?schemeLabel), "en"))
      FILTER(CONTAINS(LCASE(STR(?schemeLabel)), "variable"))
    }
  )

  {
    FILTER NOT EXISTS { ?variable gcdfo:iadoptEntity ?entity . }
    BIND("missing gcdfo:iadoptEntity" AS ?issue)
  }
  UNION
  {
    FILTER NOT EXISTS { ?variable gcdfo:iadoptProperty ?property . }
    BIND("missing gcdfo:iadoptProperty" AS ?issue)
  }
}
ORDER BY ?variable ?issue
