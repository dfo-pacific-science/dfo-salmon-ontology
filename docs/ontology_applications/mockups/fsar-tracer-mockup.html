<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FSAR Advice Trace Mockup</title>
    <style>
      :root {
        --bg: #0f1117;
        --panel: #171b26;
        --panel-alt: #1f2533;
        --border: #2a3142;
        --text: #ecf2ff;
        --muted: #9aa5c6;
        --accent: #7dd3fc;
        --accent-2: #a78bfa;
        --success: #34d399;
        --warning: #facc15;
        --danger: #f87171;
        --smoke: rgba(255, 255, 255, 0.08);
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, #1b2330 0%, #0b0d12 45%, #050608 100%);
        color: var(--text);
        min-height: 100vh;
      }

      .app-shell {
        padding: 32px 40px 48px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .top-bar,
      .ribbon,
      .diff-panel,
      .graph-panel,
      .drawer {
        background: linear-gradient(145deg, rgba(31, 37, 51, 0.92), rgba(12, 14, 20, 0.92));
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px 24px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .identity {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .identity small {
        color: var(--muted);
        letter-spacing: 0.08em;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--smoke);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 13px;
        color: var(--text);
      }

      .chip.ready {
        background: rgba(52, 211, 153, 0.1);
        border-color: rgba(52, 211, 153, 0.6);
        color: var(--success);
      }

      .chip.partial {
        background: rgba(250, 204, 21, 0.12);
        border-color: rgba(250, 204, 21, 0.6);
        color: var(--warning);
      }

      .chip.blocked {
        background: rgba(248, 113, 113, 0.12);
        border-color: rgba(248, 113, 113, 0.6);
        color: var(--danger);
      }

      label.selector {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .selectors {
        display: flex;
        gap: 16px;
        align-items: flex-end;
      }

      select,
      button,
      .persona-btn {
        background: var(--panel-alt);
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--text);
        padding: 8px 14px;
        font-size: 14px;
        font-family: inherit;
        cursor: pointer;
        transition: border 0.2s ease, transform 0.2s ease;
      }

      select:focus,
      button:focus,
      .persona-btn:focus {
        outline: none;
        border-color: var(--accent);
      }

      button.primary {
        background: linear-gradient(120deg, #4c7dff, #7f5dff);
        border: none;
        box-shadow: 0 10px 25px rgba(86, 126, 255, 0.4);
      }

      button.secondary {
        background: rgba(125, 211, 252, 0.15);
        border-color: rgba(125, 211, 252, 0.4);
        color: var(--accent);
      }

      .ribbon {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .popover {
        position: absolute;
        top: 110%;
        right: 0;
        background: var(--panel-alt);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        width: 260px;
        font-size: 13px;
        color: var(--muted);
        display: none;
      }

      .popover.visible {
        display: block;
      }

      .diff-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .diff-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed var(--border);
        border-radius: 12px;
        padding: 16px;
      }

      .diff-card strong {
        display: block;
        margin-bottom: 8px;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .main-grid {
        display: grid;
        grid-template-columns: minmax(0, 3fr) minmax(360px, 1fr);
        gap: 24px;
      }

      .graph-panel {
        min-height: 560px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #traceGraph {
        width: 100%;
        height: 520px;
        border-radius: 16px;
        background: rgba(23, 27, 38, 0.7);
      }

      .graph-header,
      .graph-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .persona-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .persona-btn {
        border-radius: 999px;
        padding: 8px 16px;
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.03);
        color: var(--muted);
      }

      .persona-btn.active {
        border-color: var(--accent);
        color: var(--text);
        background: rgba(125, 211, 252, 0.14);
      }

      .quick-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .quick-links button {
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 13px;
        border-color: rgba(255, 255, 255, 0.12);
      }

      .drawer {
        min-height: 560px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .drawer h2 {
        margin: 0;
        font-size: 20px;
      }

      .drawer-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .drawer-header small {
        color: var(--muted);
      }

      .badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge {
        border-radius: 8px;
        padding: 4px 10px;
        font-size: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
      }

      .badge.complete {
        color: var(--success);
        border-color: rgba(52, 211, 153, 0.5);
      }

      .badge.gaps {
        color: var(--warning);
        border-color: rgba(250, 204, 21, 0.5);
      }

      .badge.missing {
        color: var(--danger);
        border-color: rgba(248, 113, 113, 0.5);
      }

      .tab-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 8px;
      }

      .tab-button {
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid transparent;
        color: var(--muted);
        font-size: 13px;
      }

      .tab-button.active {
        border-color: var(--accent-2);
        color: var(--text);
        background: rgba(167, 139, 250, 0.18);
      }

      .tab-content {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        background: rgba(5, 7, 11, 0.3);
        min-height: 180px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .tab-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        padding-bottom: 10px;
      }

      .tab-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .tab-item strong {
        display: block;
        font-size: 14px;
      }

      .tab-item span {
        display: block;
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }

      .provenance {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        padding: 12px;
        border: 1px dashed rgba(255, 255, 255, 0.12);
        font-size: 13px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }

      .risk-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .risk-chip {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        background: rgba(248, 204, 21, 0.12);
        border: 1px solid rgba(248, 204, 21, 0.4);
        color: var(--warning);
        cursor: pointer;
      }

      .document-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        background: rgba(255, 255, 255, 0.02);
      }

      .document-card footer {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .document-card footer button {
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
      }

      .evidence-badge {
        border-radius: 8px;
        padding: 2px 8px;
        font-size: 11px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .node-rect {
        fill: rgba(11, 15, 25, 0.95);
        stroke: rgba(255, 255, 255, 0.08);
        stroke-width: 1.5;
        rx: 16;
      }

      .node.active .node-rect {
        stroke: var(--accent);
        stroke-width: 2;
        filter: drop-shadow(0 0 12px rgba(125, 211, 252, 0.4));
      }

      .node.deemphasized {
        opacity: 0.45;
      }

      .status-dot {
        r: 6;
      }

      .status-red {
        fill: var(--danger);
      }

      .status-amber {
        fill: var(--warning);
      }

      .status-green {
        fill: var(--success);
      }

      .edge {
        stroke: rgba(255, 255, 255, 0.15);
        stroke-width: 2;
        marker-end: url(#arrowhead);
      }

      .edge.highlighted {
        stroke: var(--accent);
        stroke-width: 2.4;
      }

      .legend {
        display: flex;
        gap: 24px;
        font-size: 12px;
        color: var(--muted);
      }

      .legend span {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
        .drawer {
          order: 2;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="top-bar">
        <div class="identity">
          <small>Advice Trace Pack</small>
          <h1>Barkley Sockeye FSAR • 2025 Cycle</h1>
        </div>
        <div class="selectors">
          <label class="selector">
            Stock Management Unit
            <select>
              <option>Barkley Sockeye</option>
              <option>Fraser Early Stuart</option>
              <option>Kitimat River Sockeye</option>
            </select>
          </label>
          <label class="selector">
            Year
            <select>
              <option>2025</option>
              <option>2024</option>
              <option>2023</option>
            </select>
          </label>
          <button class="primary" id="exportPack">Export Advice Trace Pack</button>
        </div>
      </header>

      <section class="ribbon">
        <div class="chip ready">Ready • Evidence Complete</div>
        <div>
          <button class="secondary" data-action="why-not-ready">Why not Ready?</button>
          <div class="popover" id="readinessPopover">
            <strong>Blocking items cleared.</strong>
            <ul>
              <li>Proxy justification uploaded (2025-10-12)</li>
              <li>GSI assignment uncertainty acknowledged</li>
              <li>Rebuilding Plan link verified</li>
            </ul>
          </div>
        </div>
        <div class="legend">
          <span><span class="dot" style="background: var(--danger);"></span> Red = Missing-critical</span>
          <span><span class="dot" style="background: var(--warning);"></span> Amber = Gaps</span>
          <span><span class="dot" style="background: var(--success);"></span> Green = Complete</span>
        </div>
      </section>

      <section class="diff-panel">
        <div class="diff-card">
          <strong>Status Change</strong>
          <div>SMU status moved from Amber → Red (escapement below LRP)</div>
        </div>
        <div class="diff-card">
          <strong>Method Delta</strong>
          <div>Adopted Bayesian age-class weighting (commit 9f1a2c9)</div>
        </div>
        <div class="diff-card">
          <strong>Benchmark Update</strong>
          <div>USR recalculated with 2005-2024 window</div>
        </div>
        <div class="diff-card">
          <strong>Advice Adjustment</strong>
          <div>Harvest option shifted to "Conservation only"</div>
        </div>
      </section>

      <section class="graph-panel">
        <div class="graph-header">
          <div>
            <h2>Advice Trace Flow</h2>
            <small>Data → CU → SMU → Advice → Decision → Policy</small>
          </div>
          <div class="persona-toggle" id="personaToggle">
            <span>Profile:</span>
            <button class="persona-btn" data-persona="biologist">Biologist / Scientist</button>
            <button class="persona-btn" data-persona="steward">Data Steward / Custodian</button>
            <button class="persona-btn" data-persona="executive">Executive / Director</button>
          </div>
        </div>
        <div class="graph-actions">
          <div class="quick-links" id="quickLinks"></div>
          <div>
            <button class="secondary" id="resetGraph">Reset View</button>
          </div>
        </div>
        <svg id="traceGraph" role="img" aria-label="FSAR Advice trace network">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="rgba(255, 255, 255, 0.25)">
              <polygon points="0 0, 10 3.5, 0 7"></polygon>
            </marker>
          </defs>
        </svg>
      </section>

      <aside class="drawer" id="evidenceDrawer">
        <div class="drawer-header">
          <div>
            <small>Evidence Drawer</small>
            <h2 id="drawerTitle">Select a node to inspect provenance</h2>
          </div>
          <div class="badge-row" id="drawerBadges"></div>
          <div class="risk-chips" id="riskChips"></div>
          <div class="persona-brief" id="personaBrief"></div>
          <div class="provenance" id="provenanceBlock"></div>
        </div>
        <div class="tab-bar" id="tabBar"></div>
        <div class="tab-content" id="tabContent"></div>
      </aside>
    </div>

    <script>
      const tabs = [
        { key: "Data", label: "Data" },
        { key: "Methods", label: "Methods" },
        { key: "Benchmarks", label: "Benchmarks" },
        { key: "Uncertainty", label: "Uncertainty" },
        { key: "Policy", label: "Policy / Legal" },
        { key: "Changes", label: "Changes" },
        { key: "Currency", label: "Currency" },
        { key: "Documents", label: "Documents" }
      ];

      const personaProfiles = {
        biologist: {
          label: "Biologist / Scientist",
          emphasis: ["dataset", "cu", "smu", "method", "advice"],
          summary: "Show full methodological context, code commits, and benchmark derivations.",
        },
        steward: {
          label: "Data Steward / Custodian",
          emphasis: ["dataset", "method", "advice"],
          summary: "Highlight provenance, QC flags, and stewardship responsibilities.",
        },
        executive: {
          label: "Executive / Director",
          emphasis: ["smu", "advice", "decision", "policy", "document"],
          summary: "Surface readiness, decisions, and compliance checkpoints.",
        },
      };

      const riskTabMap = {
        "Proxy justification missing": "Methods",
        "No status CI": "Uncertainty",
        "Currency check overdue": "Currency",
      };

      const nodes = [
        {
          id: "dataset-escapement",
          label: "Escapement Flights",
          subtitle: "Aerial + DIDSON (2015-2024)",
          level: 0,
          order: 1,
          type: "dataset",
          status: "amber",
          evidence: "Complete",
          readiness: "Partial",
          badges: ["QC Verified"],
          children: [],
          provenance: {
            source: "SPSR Run #88",
            method: "GRD import v2.7",
            reviewed: "Dr. Rahman • 2025-09-30",
          },
          risks: ["Currency check overdue"],
          details: {
            Data: [
              {
                label: "Coverage",
                value: "2015-2024 aerial photos, DIDSON counts",
                meta: "Units: spawners | QC: Tier-1",
                jump: "Jump to SPSR record",
              },
              {
                label: "Escapement estimate",
                value: "242,000 ± 18,000",
                meta: "Downgrade criteria: Visibility",
                jump: "Open GRD sample",
              },
            ],
            Methods: [
              {
                label: "Imputation",
                value: "Kalman smoother w/ 3 year memory",
                meta: "Parameters: rho=0.68",
                jump: "View code commit",
              },
            ],
            Benchmarks: [
              { label: "LRP reference", value: "Linked to CU Henderson" },
            ],
            Uncertainty: [
              {
                label: "Observation variance",
                value: "σ² = 0.18",
                meta: "Sample size = 12 surveys",
              },
            ],
            Policy: [
              { label: "Use in Advice", value: "Feeds CU Henderson status" },
            ],
            Changes: [
              { label: "New surveys", value: "+2 electrofishing transects compared to 2024" },
            ],
            Currency: [
              { label: "Last updated", value: "2025-08-30", meta: "⚠︎ 14 months since last QC" },
            ],
            Documents: [],
          },
        },
        {
          id: "dataset-gsi",
          label: "GSI Assignments",
          subtitle: "Sampled 2023-2025",
          level: 0,
          order: 2,
          type: "dataset",
          status: "green",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["Published"],
          children: [],
          provenance: {
            source: "GRD Batch 511",
            method: "GSI pipeline v4.1",
            reviewed: "A. Sheppard • 2025-09-18",
          },
          risks: [],
          details: {
            Data: [
              { label: "Samples", value: "412 adipose, 102 otolith", meta: "n=514" },
              { label: "Assignment accuracy", value: "94.6%", meta: "CI ± 2.1%" },
            ],
            Methods: [
              { label: "Panel", value: "GRD_SOCKEYE_CORE", meta: "v4.1" },
            ],
            Benchmarks: [],
            Uncertainty: [
              { label: "Misassignment", value: "0.7 probability for Sarita/Hend overlap" },
            ],
            Policy: [],
            Changes: [
              { label: "Panel update", value: "Added 28 SNP markers" },
            ],
            Currency: [
              { label: "Last synced", value: "2025-10-02", meta: "Fresh" },
            ],
            Documents: [],
          },
        },
        {
          id: "dataset-flow",
          label: "Hydro Proxies",
          subtitle: "Flow gauge + temp",
          level: 0,
          order: 3,
          type: "dataset",
          status: "amber",
          evidence: "Gaps",
          readiness: "Partial",
          badges: ["Proxy"],
          children: [],
          provenance: {
            source: "EnvCan Gauge 08HB002",
            method: "Proxy translator v1.8",
            reviewed: "Pending",
          },
          risks: ["Proxy justification missing"],
          details: {
            Data: [
              { label: "Proxy coverage", value: "Flow gauge 2010-2025", meta: "Missing 2016" },
            ],
            Methods: [
              { label: "Translation", value: "Linear regression (R²=0.62)", meta: "Need reviewer" },
            ],
            Benchmarks: [],
            Uncertainty: [
              { label: "Proxy error", value: "±24%", meta: "Downgrade invoked" },
            ],
            Policy: [],
            Changes: [
              { label: "Proxy use", value: "First used 2025 cycle" },
            ],
            Currency: [
              { label: "Calibration", value: "Not run since 2023", meta: "Flag" },
            ],
            Documents: [],
          },
        },
        {
          id: "cu-henderson",
          label: "CU₁ Henderson",
          subtitle: "Status: Amber",
          level: 1,
          order: 1,
          type: "cu",
          status: "amber",
          evidence: "Complete",
          readiness: "Partial",
          badges: ["Evidence badges", "GSI present"],
          children: ["dataset-escapement", "smu-barkley"],
          provenance: {
            source: "Escapement flights + DIDSON",
            method: "Bayes aggregator v3.2",
            reviewed: "FSAR QA • 2025-10-05",
          },
          risks: ["No status CI"],
          details: {
            Data: [
              { label: "Escapement", value: "242k", meta: "CI missing" },
              { label: "GSI", value: "Used", meta: "n=182" },
            ],
            Methods: [
              { label: "Aggregation", value: "Hierarchical aggregator", meta: "commit 9f1a2c9" },
            ],
            Benchmarks: [
              { label: "Lower benchmark", value: "LRP 280k", meta: "Derived 2024" },
            ],
            Uncertainty: [
              { label: "Status CI", value: "Pending reviewer" },
            ],
            Policy: [
              { label: "WSP zone", value: "Amber" },
            ],
            Changes: [
              { label: "Data", value: "+Escapement flights" },
            ],
            Currency: [
              { label: "Profile", value: "Updated 2025-10-12" },
            ],
            Documents: [],
          },
        },
        {
          id: "cu-sarita",
          label: "CU₂ Sarita",
          subtitle: "Status: Red",
          level: 1,
          order: 2,
          type: "cu",
          status: "red",
          evidence: "Missing-critical",
          readiness: "Blocked",
          badges: ["Escapement gap"],
          children: ["dataset-gsi", "smu-barkley"],
          provenance: {
            source: "GSI Assignments",
            method: "Proxy + enumeration",
            reviewed: "Pending",
          },
          risks: ["No status CI", "Proxy justification missing"],
          details: {
            Data: [
              { label: "Proxy reliance", value: "60% flow proxy", meta: "Needs reviewer" },
            ],
            Methods: [
              { label: "Proxy weighting", value: "0.4 manual override" },
            ],
            Benchmarks: [
              { label: "LRP", value: "310k", meta: "Confidence low" },
            ],
            Uncertainty: [
              { label: "Assignment", value: "High" },
            ],
            Policy: [
              { label: "Trigger", value: "Below LRP" },
            ],
            Changes: [
              { label: "Downgrade", value: "Applied 2025" },
            ],
            Currency: [
              { label: "Update", value: "Awaiting review" },
            ],
            Documents: [],
          },
        },
        {
          id: "cu-stamp",
          label: "CU₃ Stamp",
          subtitle: "Status: Green",
          level: 1,
          order: 3,
          type: "cu",
          status: "green",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["Benchmark updated"],
          children: ["dataset-flow", "smu-barkley"],
          provenance: {
            source: "Hydro proxies",
            method: "Proxy translator v1.8",
            reviewed: "Pending",
          },
          risks: ["Proxy justification missing"],
          details: {
            Data: [
              { label: "Escapement (proxy)", value: "Est. 410k" },
            ],
            Methods: [{ label: "Proxy weighting", value: "0.25" }],
            Benchmarks: [{ label: "USR", value: "620k" }],
            Uncertainty: [{ label: "Proxy error", value: "±15%" }],
            Policy: [{ label: "Zone", value: "Green" }],
            Changes: [{ label: "Proxy doc", value: "Draft" }],
            Currency: [{ label: "Reviewer", value: "Assign" }],
            Documents: [],
          },
        },
        {
          id: "smu-barkley",
          label: "Barkley Sockeye SMU",
          subtitle: "Status: Red (worst CU)",
          level: 2,
          order: 1,
          type: "smu",
          status: "red",
          evidence: "Gaps",
          readiness: "Partial",
          badges: ["Worst case logic", "Evidence badges"],
          children: ["method-agg", "advice-node"],
          provenance: {
            source: "CU aggregation",
            method: "Worst-case rule",
            reviewed: "FSAR Review Board",
          },
          risks: ["No status CI"],
          details: {
            Data: [
              { label: "Included CUs", value: "Henderson, Sarita, Stamp" },
              { label: "Excluded", value: "Nahmint (missing data)" },
            ],
            Methods: [
              { label: "Aggregation", value: "Worst-case w/ override" },
            ],
            Benchmarks: [
              { label: "LRP logic", value: "If any CU red → red" },
            ],
            Uncertainty: [
              { label: "Status CI", value: "Not published" },
            ],
            Policy: [
              { label: "WSP zone", value: "Red" },
            ],
            Changes: [
              { label: "Benchmarks", value: "USR window extended" },
            ],
            Currency: [
              { label: "Reviewed", value: "2025-10-14" },
            ],
            Documents: [],
          },
        },
        {
          id: "method-agg",
          label: "Methods + Benchmarks",
          subtitle: "Bayes aggregator + LRP",
          level: 2,
          order: 2,
          type: "method",
          status: "amber",
          evidence: "Gaps",
          readiness: "Partial",
          badges: ["LRP derivation"],
          children: ["advice-node"],
          provenance: {
            source: "Method registry",
            method: "Aggregator v3.2",
            reviewed: "QA scientist",
          },
          risks: [],
          details: {
            Data: [],
            Methods: [
              { label: "Aggregator", value: "Bayesian" },
              { label: "Code", value: "GitHub commit 9f1a2c9" },
            ],
            Benchmarks: [
              { label: "LRP", value: "280k" },
              { label: "USR", value: "520k" },
            ],
            Uncertainty: [
              { label: "Propagation", value: "Monte Carlo" },
            ],
            Policy: [],
            Changes: [
              { label: "Method", value: "Added Bayesian weighting" },
            ],
            Currency: [
              { label: "Version", value: "v3.2 (Oct 2025)" },
            ],
            Documents: [
              {
                type: "Method Note",
                title: "Benchmarks workbook",
                docNo: "Workbook v3.2",
                year: 2025,
                size: "1.2 MB",
                public: false,
              },
            ],
          },
        },
        {
          id: "advice-node",
          label: "Scientific Advice",
          subtitle: "FSAR 2025",
          level: 3,
          order: 1,
          type: "advice",
          status: "red",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["FSAR", "Tech Report"],
          children: ["doc-fsar", "doc-research", "decision-node", "policy-wsp", "policy-fisheries"],
          provenance: {
            source: "CSAS FSAR",
            method: "Advice Trace Pack",
            reviewed: "Lead author",
          },
          risks: [],
          details: {
            Data: [
              { label: "Status", value: "Red", meta: "Worst-case" },
            ],
            Methods: [
              { label: "Advice logic", value: "Precautionary" },
            ],
            Benchmarks: [
              { label: "Trigger", value: "Below LRP" },
            ],
            Uncertainty: [
              { label: "CI", value: "Pending publication" },
            ],
            Policy: [
              { label: "Fisheries Act", value: "s.6.2" },
            ],
            Changes: [
              { label: "Advice text", value: "Now prohibits directed harvest" },
            ],
            Currency: [
              { label: "Advice version", value: "v1.3 • 2025-10-20" },
            ],
            Documents: [
              {
                type: "FSAR",
                title: "Barkley Sockeye FSAR 2025",
                docNo: "CSAS 2025/011",
                year: 2025,
                size: "14 MB",
                public: true,
              },
              {
                type: "Research",
                title: "GRD Benchmarks Study",
                docNo: "Tech Memo 2025-07",
                year: 2025,
                size: "8 MB",
                public: false,
              },
            ],
          },
        },
        {
          id: "doc-fsar",
          label: "FSAR Document",
          subtitle: "CSAS 2025/011",
          level: 3,
          order: 2,
          type: "document",
          status: "green",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["Public"],
          children: ["decision-node"],
          provenance: {
            source: "CSAS Library",
            method: "Doc registry",
            reviewed: "CSAS",
          },
          risks: [],
          details: {
            Data: [],
            Methods: [],
            Benchmarks: [],
            Uncertainty: [],
            Policy: [{ label: "Legal", value: "Meets CSAS policy" }],
            Changes: [{ label: "Version", value: "v1.3" }],
            Currency: [{ label: "Published", value: "2025-10-22" }],
            Documents: [
              {
                type: "PDF",
                title: "FSAR Main PDF",
                docNo: "CSAS 2025/011",
                year: 2025,
                size: "14 MB",
                public: true,
              },
            ],
          },
        },
        {
          id: "doc-research",
          label: "Research Inputs",
          subtitle: "Benchmarks & Methods",
          level: 3,
          order: 3,
          type: "document",
          status: "amber",
          evidence: "Gaps",
          readiness: "Partial",
          badges: ["Internal"],
          children: ["decision-node"],
          provenance: {
            source: "GitHub Repo",
            method: "Zenodo DOI",
            reviewed: "Pending",
          },
          risks: ["Currency check overdue"],
          details: {
            Data: [],
            Methods: [
              { label: "Repo", value: "github.com/dfo/fsar-trace" },
            ],
            Benchmarks: [
              { label: "LRP workbook", value: "Zenodo DOI" },
            ],
            Uncertainty: [],
            Policy: [],
            Changes: [
              { label: "New analysis", value: "GSI assimilation" },
            ],
            Currency: [
              { label: "Last commit", value: "2025-10-18" },
            ],
            Documents: [
              {
                type: "Tech Report",
                title: "Benchmarks workbook",
                docNo: "Internal",
                year: 2025,
                size: "22 MB",
                public: false,
              },
            ],
          },
        },
        {
          id: "decision-node",
          label: "Management Decision",
          subtitle: "Conservation only",
          level: 4,
          order: 1,
          type: "decision",
          status: "red",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["Policy trigger"],
          children: ["policy-wsp", "policy-fisheries"],
          provenance: {
            source: "Regional Director",
            method: "Decision memo",
            reviewed: "2025-10-25",
          },
          risks: [],
          details: {
            Data: [
              { label: "Decision date", value: "2025-10-26" },
            ],
            Methods: [],
            Benchmarks: [],
            Uncertainty: [],
            Policy: [
              { label: "Trigger", value: "Below LRP" },
            ],
            Changes: [
              { label: "Harvest", value: "Closed" },
            ],
            Currency: [
              { label: "Effective", value: "Immediate" },
            ],
            Documents: [
              {
                type: "Decision Memo",
                title: "Conservation plan",
                docNo: "Internal",
                year: 2025,
                size: "2 MB",
                public: false,
              },
            ],
          },
        },
        {
          id: "policy-wsp",
          label: "Policy Alignment",
          subtitle: "WSP Zone mapping",
          level: 5,
          order: 1,
          type: "policy",
          status: "red",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["WSP"],
          children: [],
          provenance: {
            source: "WSP Guidance",
            method: "Zone overlay",
            reviewed: "Policy team",
          },
          risks: [],
          details: {
            Data: [],
            Methods: [],
            Benchmarks: [],
            Uncertainty: [],
            Policy: [
              { label: "Requirement", value: "Red zone triggers rebuilding" },
            ],
            Changes: [],
            Currency: [
              { label: "Policy version", value: "2024 update" },
            ],
            Documents: [],
          },
        },
        {
          id: "policy-fisheries",
          label: "Legal Framework",
          subtitle: "Fisheries Act s.6.2",
          level: 5,
          order: 2,
          type: "policy",
          status: "green",
          evidence: "Complete",
          readiness: "Ready",
          badges: ["Legal"],
          children: [],
          provenance: {
            source: "Fisheries Act",
            method: "Compliance check",
            reviewed: "Legal", 
          },
          risks: [],
          details: {
            Data: [],
            Methods: [],
            Benchmarks: [],
            Uncertainty: [],
            Policy: [
              { label: "Requirement", value: "Rebuilding plan on file" },
            ],
            Changes: [],
            Currency: [
              { label: "Verified", value: "2025-10-28" },
            ],
            Documents: [
              {
                type: "Rebuilding Plan",
                title: "Barkley Sockeye Rebuilding Plan",
                docNo: "Plan-2025-02",
                year: 2025,
                size: "4 MB",
                public: false,
              },
            ],
          },
        },
      ];

      const links = [
        { source: "dataset-escapement", target: "cu-henderson" },
        { source: "dataset-gsi", target: "cu-sarita" },
        { source: "dataset-flow", target: "cu-stamp" },
        { source: "cu-henderson", target: "smu-barkley" },
        { source: "cu-sarita", target: "smu-barkley" },
        { source: "cu-stamp", target: "smu-barkley" },
        { source: "smu-barkley", target: "method-agg" },
        { source: "method-agg", target: "advice-node" },
        { source: "smu-barkley", target: "advice-node" },
        { source: "advice-node", target: "doc-fsar" },
        { source: "advice-node", target: "doc-research" },
        { source: "doc-fsar", target: "decision-node" },
        { source: "doc-research", target: "decision-node" },
        { source: "advice-node", target: "decision-node" },
        { source: "decision-node", target: "policy-wsp" },
        { source: "decision-node", target: "policy-fisheries" },
      ];

      const nodeMap = new Map(nodes.map((node) => [node.id, node]));
      const initialVisible = new Set([
        "cu-henderson",
        "cu-sarita",
        "cu-stamp",
        "smu-barkley",
        "advice-node",
      ]);

      const state = {
        visible: new Set(initialVisible),
        persona: "executive",
        activeNodeId: "smu-barkley",
        activeTab: "Data",
      };

      const svg = document.getElementById("traceGraph");
      const drawerTitle = document.getElementById("drawerTitle");
      const drawerBadges = document.getElementById("drawerBadges");
      const tabBar = document.getElementById("tabBar");
      const tabContent = document.getElementById("tabContent");
      const riskContainer = document.getElementById("riskChips");
      const provenanceBlock = document.getElementById("provenanceBlock");
      const personaBrief = document.getElementById("personaBrief");
      const quickLinks = document.getElementById("quickLinks");

      function setActivePersona(persona) {
        state.persona = persona;
        document
          .querySelectorAll(".persona-btn")
          .forEach((btn) => btn.classList.toggle("active", btn.dataset.persona === persona));
        renderGraph();
        const profile = personaProfiles[persona];
        personaBrief.textContent = `${profile.label}: ${profile.summary}`;
      }

      function setActiveNode(nodeId) {
        state.activeNodeId = nodeId;
        const node = nodeMap.get(nodeId);
        if (node) {
          renderDrawer(node);
          renderQuickLinks(node);
        }
        renderGraph();
      }

      function renderQuickLinks(node) {
        quickLinks.innerHTML = "";
        if (!node || node.type !== "advice") {
          const tip = document.createElement("small");
          tip.textContent = "Select the Advice node to access FSAR / Research / Tech report quick links.";
          quickLinks.appendChild(tip);
          return;
        }
        ["FSAR", "Research", "Tech Report"].forEach((label) => {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.className = "secondary";
          btn.addEventListener("click", () => alert(`${label} link opening (mock).`));
          quickLinks.appendChild(btn);
        });
      }

      function renderGraph() {
        svg.innerHTML = svg.innerHTML.split("</defs>")[0] + "</defs>";
        const positions = {};
        const visibleNodes = nodes.filter((node) => state.visible.has(node.id));
        const groups = {};
        visibleNodes.forEach((node) => {
          groups[node.level] = groups[node.level] || [];
          groups[node.level].push(node);
        });

        Object.values(groups).forEach((group) => group.sort((a, b) => a.order - b.order));

        const maxLevel = Math.max(...visibleNodes.map((n) => n.level));
        const levelSpacing = 220;
        const columnWidth = 190;
        const verticalSpacing = 140;
        const svgWidth = Math.max(1200, (maxLevel + 1) * levelSpacing + 200);
        const svgHeight = Math.max(520, Math.max(...Object.values(groups).map((g) => g.length)) * verticalSpacing + 160);
        svg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);

        Object.keys(groups).forEach((level) => {
          const items = groups[level];
          const columnHeight = (items.length - 1) * verticalSpacing;
          const startY = (svgHeight - columnHeight) / 2;
          const x = 80 + level * levelSpacing;
          items.forEach((node, idx) => {
            const y = startY + idx * verticalSpacing;
            positions[node.id] = { x, y };
          });
        });

        links
          .filter((link) => state.visible.has(link.source) && state.visible.has(link.target))
          .forEach((link) => {
            const { x: x1, y: y1 } = positions[link.source];
            const { x: x2, y: y2 } = positions[link.target];
            const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const offsetX = columnWidth / 2;
            const path = `M ${x1 + offsetX} ${y1} C ${x1 + offsetX + 40} ${y1}, ${x2 - offsetX - 40} ${y2}, ${x2 - offsetX} ${y2}`;
            line.setAttribute("d", path);
            line.setAttribute("class", "edge" + (link.target === state.activeNodeId || link.source === state.activeNodeId ? " highlighted" : ""));
            line.setAttribute("marker-end", "url(#arrowhead)");
            svg.appendChild(line);
          });

        visibleNodes.forEach((node) => {
          const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          g.classList.add("node");
          if (node.id === state.activeNodeId) g.classList.add("active");
          const persona = personaProfiles[state.persona];
          if (!persona.emphasis.includes(node.type)) {
            g.classList.add("deemphasized");
          }
          const { x, y } = positions[node.id];
          g.setAttribute("transform", `translate(${x}, ${y - 40})`);

          const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
          rect.setAttribute("width", columnWidth);
          rect.setAttribute("height", "80");
          rect.setAttribute("class", "node-rect");
          g.appendChild(rect);

          const statusDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          statusDot.setAttribute("cx", 14);
          statusDot.setAttribute("cy", 18);
          statusDot.setAttribute("r", 6);
          statusDot.setAttribute("class", `status-dot status-${node.status}`);
          g.appendChild(statusDot);

          const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
          label.setAttribute("x", 30);
          label.setAttribute("y", 24);
          label.setAttribute("fill", "var(--text)");
          label.setAttribute("font-size", "14");
          label.textContent = node.label;
          g.appendChild(label);

          if (node.subtitle) {
            const sub = document.createElementNS("http://www.w3.org/2000/svg", "text");
            sub.setAttribute("x", 30);
            sub.setAttribute("y", 46);
            sub.setAttribute("fill", "var(--muted)");
            sub.setAttribute("font-size", "12");
            sub.textContent = node.subtitle;
            g.appendChild(sub);
          }

          const badge = document.createElementNS("http://www.w3.org/2000/svg", "rect");
          badge.setAttribute("x", columnWidth - 72);
          badge.setAttribute("y", 12);
          badge.setAttribute("width", 60);
          badge.setAttribute("height", 20);
          badge.setAttribute("rx", 10);
          badge.setAttribute("fill", "rgba(255,255,255,0.05)");
          g.appendChild(badge);

          const badgeText = document.createElementNS("http://www.w3.org/2000/svg", "text");
          badgeText.setAttribute("x", columnWidth - 42);
          badgeText.setAttribute("y", 26);
          badgeText.setAttribute("fill", "var(--muted)");
          badgeText.setAttribute("font-size", "11");
          badgeText.setAttribute("text-anchor", "middle");
          badgeText.textContent = node.evidence;
          g.appendChild(badgeText);

          g.addEventListener("click", () => {
            node.children?.forEach((childId) => state.visible.add(childId));
            setActiveNode(node.id);
          });

          svg.appendChild(g);
        });
      }

      function renderDrawer(node) {
        drawerTitle.textContent = `${node.label} • ${node.subtitle || node.type}`;
        drawerBadges.innerHTML = "";
        const readinessBadge = document.createElement("span");
        readinessBadge.className = `chip ${node.readiness.toLowerCase()}`;
        readinessBadge.textContent = `${node.readiness}`;
        drawerBadges.appendChild(readinessBadge);

        const evidenceBadge = document.createElement("span");
        const evidenceClass = node.evidence === "Complete" ? "complete" : node.evidence === "Gaps" ? "gaps" : "missing";
        evidenceBadge.className = `badge ${evidenceClass}`;
        evidenceBadge.textContent = `Evidence: ${node.evidence}`;
        drawerBadges.appendChild(evidenceBadge);

        riskContainer.innerHTML = "";
        node.risks?.forEach((risk) => {
          const chip = document.createElement("button");
          chip.className = "risk-chip";
          chip.textContent = risk;
          chip.addEventListener("click", () => {
            const targetTab = riskTabMap[risk] || "Data";
            setActiveTab(targetTab);
          });
          riskContainer.appendChild(chip);
        });

        provenanceBlock.innerHTML = "";
        [
          { label: "Source", value: node.provenance?.source },
          { label: "Method", value: node.provenance?.method },
          { label: "Reviewer", value: node.provenance?.reviewed },
        ].forEach((item) => {
          if (!item.value) return;
          const span = document.createElement("span");
          span.innerHTML = `<strong>${item.label}</strong><br />${item.value}`;
          provenanceBlock.appendChild(span);
        });

        renderTabs();
        renderTabContent(node);
      }

      function renderTabs() {
        tabBar.innerHTML = "";
        tabs.forEach((tab) => {
          const button = document.createElement("button");
          button.className = "tab-button" + (tab.key === state.activeTab ? " active" : "");
          button.textContent = tab.label;
          button.addEventListener("click", () => setActiveTab(tab.key));
          tabBar.appendChild(button);
        });
      }

      function setActiveTab(tabKey) {
        state.activeTab = tabKey;
        const node = nodeMap.get(state.activeNodeId);
        renderTabs();
        renderTabContent(node);
      }

      function renderTabContent(node) {
        tabContent.innerHTML = "";
        if (!node) {
          tabContent.textContent = "Select a node to see evidence.";
          return;
        }
        const entries = node.details?.[state.activeTab] || [];
        if (!entries.length) {
          const empty = document.createElement("div");
          empty.className = "tab-item";
          empty.textContent = `No ${state.activeTab} records for this node.`;
          tabContent.appendChild(empty);
          return;
        }
        entries.forEach((entry) => {
          if (state.activeTab === "Documents") {
            const card = document.createElement("div");
            card.className = "document-card";
            const header = document.createElement("div");
            header.innerHTML = `<strong>${entry.type || entry.label}</strong> ${entry.title || ""}`;
            card.appendChild(header);
            if (entry.docNo) {
              const meta = document.createElement("span");
              meta.textContent = `${entry.docNo} • ${entry.year} • ${entry.size}`;
              card.appendChild(meta);
            }
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.textContent = entry.public ? "Public" : "Internal";
            card.appendChild(badge);
            const footer = document.createElement("footer");
            ["Open", "Download", "Copy citation"].forEach((action) => {
              const btn = document.createElement("button");
              btn.className = "secondary";
              btn.textContent = action;
              btn.addEventListener("click", () => alert(`${action} ${entry.title || entry.type}`));
              footer.appendChild(btn);
            });
            card.appendChild(footer);
            tabContent.appendChild(card);
            return;
          }
          const item = document.createElement("div");
          item.className = "tab-item";
          item.innerHTML = `<strong>${entry.label || entry.type}</strong>${entry.value ? `<span>${entry.value}</span>` : ""}`;
          if (entry.meta) {
            const meta = document.createElement("span");
            meta.textContent = entry.meta;
            meta.style.color = "var(--muted)";
            item.appendChild(meta);
          }
          if (entry.jump) {
            const anchor = document.createElement("button");
            anchor.className = "secondary";
            anchor.textContent = entry.jump;
            anchor.style.marginTop = "8px";
            anchor.addEventListener("click", () => alert(`Navigate to ${entry.jump}`));
            item.appendChild(anchor);
          }
          tabContent.appendChild(item);
        });
      }

      function init() {
        document.getElementById("resetGraph").addEventListener("click", () => {
          state.visible = new Set(initialVisible);
          setActiveNode("smu-barkley");
          state.activeTab = "Data";
        });

        document.getElementById("exportPack").addEventListener("click", () => {
          alert("Advice Trace Pack export queued (mock). Includes /docs & optional /data folder.");
        });

        document.querySelectorAll(".persona-btn").forEach((btn) =>
          btn.addEventListener("click", () => setActivePersona(btn.dataset.persona))
        );

        setActivePersona(state.persona);
        setActiveNode(state.activeNodeId);
        renderGraph();
      }

      document.addEventListener("click", (evt) => {
        const popover = document.getElementById("readinessPopover");
        if (evt.target.matches('[data-action="why-not-ready"]')) {
          popover.classList.toggle("visible");
        } else if (!popover.contains(evt.target)) {
          popover.classList.remove("visible");
        }
      });

      init();
    </script>
  </body>
</html>
