# Alpha 0.0.6 Review Refactor — Migration Plan

Date: 2026-02-25  
Base: `origin/alpha/0.0.6-review` @ `65c7123`

## Scope

Deliver a staged, low-risk migration for the alpha/0.0.6-review refactor with explicit PR ordering, canonical triple-rewrite patterns, and rollback safety.

---

## Exact PR sequence

### PR-1 — Conventions + naming canon
- **Branch:** `mig/conventions-alpha006-20260225`
- **Base:** `alpha/0.0.6-review`
- **Changes:**
  - Update `docs/CONVENTIONS.md` to align with current ontology predicates:
    - `gcdfo:variableHasProperty`
    - `gcdfo:variableHasObjectOfInterest`
    - `gcdfo:variableHasConstraint`
    - `gcdfo:variableHasMatrix`
    - `gcdfo:variableHasContextObject`
    - `gcdfo:variableHasStatisticalModifier`
  - Replace legacy docs references to `gcdfo:iadopt*` naming.
  - Clarify event-level procedure property as `gcdfo:usesObservationProcedure`.
- **Merge gate:** docs build sanity (`make docs-refresh`) and no stale predicate names in conventions docs.

### PR-2 — Use-case and query updates
- **Branch:** `mig/usecases-alpha006-20260225`
- **Base:** `alpha/0.0.6-review` (rebased after PR-1)
- **Changes:**
  - Update `docs/COMPETENCY_QUESTIONS.md` SPARQL examples from `gcdfo:iadopt*` to `gcdfo:variableHas*` names.
  - Align CQ examples to SKOS variable-concept pattern (`gcdfo:hasObservedVariable` -> `skos:Concept`).
  - Add/refresh query snippets for year-basis and metric SKOS checks.
- **Merge gate:** documentation consistency review (CQ examples match ontology terms).

### PR-3 — Ontology migration (core refactor)
- **Branch:** `mig/ontology-alpha006-20260225`
- **Base:** `alpha/0.0.6-review` (rebased after PR-2)
- **Changes:**
  - Apply triple-level replacements (below) in `ontology/dfo-salmon.ttl` and affected module files.
  - Migrate year-basis terms to SKOS pattern.
  - Migrate rapid-status metric terms to SKOS pattern.
  - Regenerate docs artifacts impacted by ontology changes.
- **Merge gate:** `make test`, `make quality-check`, `make docs-refresh`.

### PR-4 — Validation + CI guardrails
- **Branch:** `mig/validation-alpha006-20260225`
- **Base:** `alpha/0.0.6-review` (rebased after PR-3)
- **Changes:**
  - Add/adjust SPARQL checks for:
    - legacy `gcdfo:iadopt*` predicates,
    - migrated year-basis SKOS membership,
    - migrated metric terms no longer typed as `owl:Class`.
  - Update CI/validation docs if command flow changed.
- **Merge gate:** full `make ci` clean and idempotent docs generation.

---

## Triple-level replacement patterns

Pattern levels used below:
- **L1 (Additive):** add canonical triples without deleting legacy triples.
- **L2 (Canonicalize):** rewrite consumers/data to canonical triples.
- **L3 (Clean):** remove legacy triples and enforce via validation.

### 1) Property alignments (SOSA/PROV -> GCDFO canonical)

#### L1 (additive bridge)
```turtle
# If present in data, add canonical GCDFO equivalents
?event  sosa:hasFeatureOfInterest ?foi   -> ?event gcdfo:hasFeatureOfInterest ?foi .
?event  sosa:hasResult            ?res   -> ?event gcdfo:hasObservationResult ?res .
?event  sosa:observedProperty     ?var   -> ?event gcdfo:hasObservedVariable ?var .
?sample sosa:isSampleOf           ?strat -> ?sample gcdfo:isSampleOfStratum ?strat .
?event  sosa:usedProcedure        ?proc  -> ?event gcdfo:usesObservationProcedure ?proc .
```

#### L2 (canonicalize)
```turtle
# Canonical authoring in repo-controlled graphs
DELETE { ?s sosa:hasFeatureOfInterest ?o } INSERT { ?s gcdfo:hasFeatureOfInterest ?o } WHERE { ?s sosa:hasFeatureOfInterest ?o } ;
DELETE { ?s sosa:hasResult ?o }            INSERT { ?s gcdfo:hasObservationResult ?o } WHERE { ?s sosa:hasResult ?o } ;
DELETE { ?s sosa:observedProperty ?o }     INSERT { ?s gcdfo:hasObservedVariable ?o } WHERE { ?s sosa:observedProperty ?o } ;
DELETE { ?s sosa:isSampleOf ?o }           INSERT { ?s gcdfo:isSampleOfStratum ?o } WHERE { ?s sosa:isSampleOf ?o } ;
DELETE { ?s sosa:usedProcedure ?o }        INSERT { ?s gcdfo:usesObservationProcedure ?o } WHERE { ?s sosa:usedProcedure ?o } ;
```

#### L3 (clean)
- Keep SOSA/PROV bridge semantics in alignment modules only.
- Fail validation if canonical graphs still assert direct SOSA predicates above.

---

### 2) Variable annotation names (`iadopt*` -> `variableHas*`)

#### L1 (additive bridge)
```turtle
?v gcdfo:iadoptProperty   ?p -> ?v gcdfo:variableHasProperty ?p .
?v gcdfo:iadoptEntity     ?e -> ?v gcdfo:variableHasObjectOfInterest ?e .
?v gcdfo:iadoptConstraint ?c -> ?v gcdfo:variableHasConstraint ?c .
# If present in external drafts:
?v gcdfo:iadoptMatrix ?m  -> ?v gcdfo:variableHasMatrix ?m .
?v gcdfo:iadoptContextObject ?co -> ?v gcdfo:variableHasContextObject ?co .
?v gcdfo:iadoptStatisticalModifier ?sm -> ?v gcdfo:variableHasStatisticalModifier ?sm .
```

#### L2 (canonicalize)
- Rewrite docs, SPARQL examples, and curated triples to `gcdfo:variableHas*` names only.
- Keep `gcdfo:usesObservationProcedure` for event-level procedure linkage.

#### L3 (clean)
- Remove remaining `gcdfo:iadopt*` predicates from maintained files.
- Add validation query that returns non-empty output if any `gcdfo:iadopt*` predicate remains.

---

### 3) Year-basis SKOS migration

#### L1 (add SKOS structure)
```turtle
:YearBasisScheme a skos:ConceptScheme ;
  skos:hasTopConcept gcdfo:YearBasis .

gcdfo:YearBasis a skos:Concept ;
  skos:inScheme :YearBasisScheme .

gcdfo:BroodYear  a skos:Concept ; skos:broader gcdfo:YearBasis ; skos:inScheme :YearBasisScheme .
gcdfo:CatchYear  a skos:Concept ; skos:broader gcdfo:YearBasis ; skos:inScheme :YearBasisScheme .
gcdfo:ReturnYear a skos:Concept ; skos:broader gcdfo:YearBasis ; skos:inScheme :YearBasisScheme .
```

#### L2 (canonicalize property range + usage)
```turtle
# Range migration
gcdfo:hasYearBasis rdfs:range skos:Concept .

# Usage migration pattern
?m gcdfo:hasYearBasis ?basisNode .
?basisNode a gcdfo:BroodYear .
=>
?m gcdfo:hasYearBasis gcdfo:BroodYear .
```

#### L3 (clean)
- Remove legacy year-basis class hierarchy axioms used only for OWL class typing:
  - `gcdfo:YearBasis a owl:Class`
  - `gcdfo:BroodYear/CatchYear/ReturnYear a owl:Class`
  - related `rdfs:subClassOf` links for that hierarchy.
- Validation: each object of `gcdfo:hasYearBasis` must be in `:YearBasisScheme`.

---

### 4) Metrics SKOS migration

#### Migration scope (this cycle)
Primary rapid-status metric class IRIs:
- `gcdfo:GenerationalAverageAbundance`
- `gcdfo:LongTermTrendMetric`
- `gcdfo:PercentChangeMetric`
- `gcdfo:BenchmarkRatioMetric`
- `gcdfo:ProbabilityDeclineBelowLowerBenchmarkMetric`
- `gcdfo:AbundancePercentileMetric`
- `gcdfo:RapidStatusScoreMetric`

Spawner-derived metric class IRIs:
- `gcdfo:SpawnerAbundance`
- `gcdfo:RelativeSpawnerAbundance`
- `gcdfo:RelativeWildSpawnerAbundance`
- `gcdfo:RelativeHatcherySpawnerAbundance`
- `gcdfo:SpawnerAbundanceChange`
- `gcdfo:RelativeSpawnerAbundanceChange`
- `gcdfo:RelativeWildSpawnerAbundanceChange`
- `gcdfo:RelativeHatcherySpawnerAbundanceChange`
- `gcdfo:SpawnerAbundanceTrend`
- `gcdfo:RelativeSpawnerAbundanceTrend`
- `gcdfo:RelativeWildSpawnerAbundanceTrend`
- `gcdfo:RelativeHatcherySpawnerAbundanceTrend`
- `gcdfo:SpawnerAbundancePercentile`
- `gcdfo:RelativeSpawnerAbundancePercentile`
- `gcdfo:RelativeWildSpawnerAbundancePercentile`
- `gcdfo:RelativeHatcherySpawnerAbundancePercentile`

#### L1 (add SKOS structure)
```turtle
:RapidStatusMetricScheme a skos:ConceptScheme ;
  skos:hasTopConcept gcdfo:RapidStatusMetric .

gcdfo:RapidStatusMetric a skos:Concept ;
  skos:inScheme :RapidStatusMetricScheme .

# For each migrated metric term (?metric)
?metric a skos:Concept ;
  skos:inScheme :RapidStatusMetricScheme ;
  skos:broader gcdfo:RapidStatusMetric .
```

#### L2 (canonicalize hierarchy + usage)
```turtle
# Hierarchy migration
?metric rdfs:subClassOf ?parentMetric .
=>
?metric skos:broader ?parentMetric .

# Instance usage migration (where metrics were used as rdf:type)
?x rdf:type ?metric .
=>
?x gcdfo:hasObservedVariable ?metric .
```

#### L3 (clean)
- Remove `owl:Class` typing and `rdfs:subClassOf` assertions for migrated metric IRIs.
- Keep non-metric process/entity OWL classes unchanged.
- Validation: migrated metric IRIs must be `skos:Concept` and must not be `owl:Class`.

---

## Validation / test checklist

Run in repo root after each PR rebase and before merge:

1. `make test`
2. `make quality-check`
3. `make docs-refresh`
4. `git diff --stat` (confirm only intended files changed)

Additional migration checks:

5. No legacy variable annotation predicates remain:
   - `grep -RIn "gcdfo:iadoptProperty\|gcdfo:iadoptEntity\|gcdfo:iadoptConstraint\|gcdfo:iadoptMethod" ontology docs scripts`
6. Year-basis values are SKOS-scheme members (query check in validation PR).
7. Migrated metric IRIs are not still typed as `owl:Class`.
8. `docs/gcdfo.{ttl,owl,jsonld}` and `docs/index.html` regenerated and consistent.

---

## Rollback notes

- **Rollback unit = one PR** (revert in reverse merge order).
- Revert order:
  1. PR-4 validation
  2. PR-3 ontology
  3. PR-2 usecases
  4. PR-1 conventions
- After each revert: run `make test` to verify branch stability.
- If only metric/year-basis migration must be undone, revert PR-3 and keep PR-1/PR-2 doc normalization.

---

## Integration order for topic branches

Integrate in this exact order onto `alpha/0.0.6-review`:

1. `mig/conventions-alpha006-20260225`
2. `mig/usecases-alpha006-20260225`
3. `mig/ontology-alpha006-20260225`
4. `mig/validation-alpha006-20260225`

Rationale: terminology contract first, then query/examples, then ontology rewrites, then enforcement/CI.
